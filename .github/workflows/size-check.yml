name: 'Package size check'

on:
  pull_request:
    branches: trunk

jobs:
  size_check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.0'
          tools: composer
      - name: Get branch name
        id: branch-name
        uses: tj-actions/branch-names@v5.2
      - name: Install deps
        run: cd mailpoet;composer install
      - name: Download ZIP files
        id: process-zips
        env:
          WP_CIRCLECI_USERNAME: ${{ secrets.WP_CIRCLECI_USERNAME }}
          WP_CIRCLECI_TOKEN: ${{ secrets.WP_CIRCLECI_TOKEN }}
          WP_GITHUB_USERNAME: ${{ secrets.WP_GITHUB_USERNAME }}
          WP_GITHUB_TOKEN: ${{ secrets.WP_GITHUB_TOKEN }}
        run: |
          cd mailpoet
          touch .env
          MESSAGE=$(./do branch:zip-delta MAILPOET-3985-pregenerate-twig-templates)
          echo "::set-output name=SIZE_DELTA_MESSAGE::$(echo $MESSAGE)"
      - name: Find Comment
        uses: peter-evans/find-comment@v2
        id: find-comment
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: Delta for mailpoet
      - name: Create or update comment
        uses: peter-evans/create-or-update-comment@v2
        with:
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          body: ${{ steps.process-zips.outputs.SIZE_DELTA_MESSAGE }}
          edit-mode: replace
